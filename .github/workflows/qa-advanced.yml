name: ğŸš€ QA Advanced Tests - SPRINT 3.2

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  qa-advanced:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ” Run Linting
        run: npm run lint

      - name: ğŸ—ï¸ Build Production
        run: npm run build

      - name: ğŸš€ Start Development Server
        run: npm run dev &
        env:
          PORT: 3000

      - name: â³ Wait for server
        run: |
          timeout 30 bash -c 'until curl -f http://localhost:3000 > /dev/null 2>&1; do sleep 2; done'
        continue-on-error: true

      - name: ğŸ“Š Lighthouse Performance Tests
        run: npm run test:lighthouse
        continue-on-error: false

      - name: â™¿ Accessibility Tests (Axe-core)
        run: npm run test:accessibility
        continue-on-error: false

      - name: âš¡ Performance Budget Tests
        run: npm run test:performance
        continue-on-error: false

      - name: ğŸŒ Cross-browser Tests
        run: npm run test:cross-browser
        continue-on-error: false

      - name: ğŸ“ˆ Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: qa-test-results
          path: |
            test-results/
            playwright-report/
          retention-days: 30

  performance-baseline:
    runs-on: ubuntu-latest
    needs: qa-advanced
    if: github.ref == 'refs/heads/main'

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸš€ Start server for baseline
        run: npm run dev &
        env:
          PORT: 3000

      - name: ğŸ“Š Generate Performance Baseline
        run: |
          npm run test:lighthouse -- --reporter=json > lighthouse-results.json
          cat lighthouse-results.json

      - name: ğŸ’¾ Store Performance Baseline
        uses: actions/upload-artifact@v4
        with:
          name: performance-baseline
          path: lighthouse-results.json
          retention-days: 90

  accessibility-audit:
    runs-on: ubuntu-latest
    needs: qa-advanced

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸš€ Start server for accessibility audit
        run: npm run dev &
        env:
          PORT: 3000

      - name: â™¿ Generate Accessibility Report
        run: |
          npm run test:accessibility -- --reporter=json > accessibility-results.json
          cat accessibility-results.json

      - name: ğŸ’¾ Store Accessibility Report
        uses: actions/upload-artifact@v4
        with:
          name: accessibility-report
          path: accessibility-results.json
          retention-days: 90

  quality-gate:
    runs-on: ubuntu-latest
    needs: [qa-advanced, performance-baseline, accessibility-audit]
    if: always()

    steps:
      - name: ğŸ¯ Quality Gate Check
        run: |
          # Verificar se todos os jobs anteriores passaram
          if [[ "${{ needs.qa-advanced.result }}" == "success" && \
                "${{ needs.performance-baseline.result }}" == "success" && \
                "${{ needs.accessibility-audit.result }}" == "success" ]]; then
            echo "âœ… QUALITY GATE PASSED - Ready for production!"
            echo "ğŸ‰ All advanced QA tests completed successfully"
            echo "ğŸ“Š Performance: â‰¥95"
            echo "â™¿ Accessibility: WCAG 2.1 AA"
            echo "âš¡ Performance Budgets: Within limits"
            echo "ğŸŒ Cross-browser: All compatible"
            exit 0
          else
            echo "âŒ QUALITY GATE FAILED"
            echo "ğŸš¨ Some QA tests failed - Review and fix issues"
            exit 1
          fi

  deploy-gate:
    runs-on: ubuntu-latest
    needs: quality-gate
    if: github.ref == 'refs/heads/main' && needs.quality-gate.result == 'success'

    steps:
      - name: ğŸš€ Deploy to Production
        run: |
          echo "ğŸ‰ QUALITY GATE PASSED!"
          echo "ğŸš€ Ready for production deployment"
          echo "ğŸ“Š All metrics within acceptable ranges"
          echo "âœ… Advanced QA tests: PASSED"

      - name: ğŸ“¢ Notify Deployment Team
        run: |
          echo "ğŸ”¥ Production deployment approved!"
          echo "Quality metrics validated:"
          echo "  â€¢ Lighthouse Performance: â‰¥95"
          echo "  â€¢ Accessibility Score: â‰¥95"
          echo "  â€¢ Performance Budgets: OK"
          echo "  â€¢ Cross-browser Compatibility: OK"
